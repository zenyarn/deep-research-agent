# AI 模型集成

本文档将指导你优化 Deep Research AI Agent 项目中的 AI 模型集成，包括配置不同任务的模型选择、优化提示词以及处理模型特定的要求。

## 步骤概览

1. 配置模型选择
2. 优化 OpenRouter 集成
3. 配置 Exa Search API
4. 优化提示词工程
5. 实现模型错误处理策略
6. 测试模型性能

## 详细步骤与提示词

### 1. 配置模型选择

**提示词：**

```
请为 deep-research-ai-agent 项目配置模型选择策略。每个研究任务可能需要不同的模型以平衡性能和成本。

具体要求：
1. 更新 src/app/api/deep-research/constants.ts 文件中的 MODELS 对象，配置以下任务的模型：
   - PLANNING: 用于生成搜索查询（推荐使用 openai/gpt-4o）
   - EXTRACTION: 用于从搜索结果中提取信息（推荐使用 openai/gpt-4o-mini）
   - ANALYSIS: 用于分析研究发现（推荐使用 openai/gpt-4o）
   - REPORT: 用于生成研究报告（推荐使用 google/gemini-2.0-flash-thinking-exp:free）

2. 提供每个模型选择的理由，考虑以下因素：
   - 任务复杂性
   - 输入量
   - 创造性需求
   - 成本效益

请提供更新后的 MODELS 对象定义，并解释每个选择的合理性。
```

**测试方法：**

- 验证 MODELS 对象格式是否正确
- 确认每个模型标识符在 OpenRouter 中是否有效
- 测试每个模型在各自任务上的基本功能

### 2. 优化 OpenRouter 集成

**提示词：**

```
请优化 deep-research-ai-agent 项目中的 OpenRouter 集成。这将确保我们能够有效地使用各种 AI 模型，并处理相关限制和错误。

具体要求：
1. 更新 src/app/api/deep-research/services.ts 文件：
   - 添加 openrouter 函数，接收模型标识符并返回完整的 OpenRouter 模型标识符
   - 配置适当的默认参数（如温度、top_p 等）
   - 确保 API 密钥验证和错误处理

2. 更新 src/app/api/deep-research/model-caller.ts 文件：
   - 使用 openrouter 函数构建完整的模型标识符
   - 为不同类型的模型调用配置适当的参数
   - 处理模型特定的错误和限制

3. 实现基本的费用跟踪功能，记录不同模型的使用情况和令牌消耗

请提供更新后的代码，并说明如何有效地管理多模型集成。
```

**测试方法：**

- 测试 openrouter 函数对各种模型标识符的处理
- 验证错误处理和重试逻辑是否正确
- 确认费用跟踪功能记录准确

### 3. 配置 Exa Search API

**提示词：**

```
请优化 deep-research-ai-agent 项目中的 Exa Search API 配置。Exa Search 是获取高质量研究内容的关键，我们需要确保其配置最适合研究任务。

具体要求：
1. 更新 src/app/api/deep-research/research-functions.ts 文件中的 search 函数：
   - 优化搜索参数，如类型、结果数量、日期范围等
   - 添加过滤选项，排除不相关的域或内容类型
   - 优化内容提取参数，确保获取足够但不过多的文本

2. 实现可选的高级搜索功能：
   - 按时间排序（最新优先）
   - 内容类型过滤（如博客、新闻、学术文章等）
   - 关键字高亮或上下文提取

3. 添加适当的错误处理和退避策略，处理 API 限制或服务不可用的情况

请提供更新后的 search 函数代码，并解释每个参数选择的理由。
```

**测试方法：**

- 使用多种查询测试 search 函数
- 验证结果数量和质量是否符合预期
- 测试错误处理和退避策略
- 比较不同搜索参数组合的结果质量

### 4. 优化提示词工程

**提示词：**

```
请优化 deep-research-ai-agent 项目中的提示词工程。提示词的质量直接影响 AI 模型的输出，我们需要确保每个提示词都能最大化模型性能。

具体要求：
1. 更新 src/app/api/deep-research/prompts.ts 文件中的系统提示词，特别关注：

   - EXTRACTION_SYSTEM_PROMPT:
     - 改进指导模型提取相关信息的指令
     - 添加更明确的格式要求
     - 强调提取事实性内容而非观点

   - ANALYSIS_SYSTEM_PROMPT:
     - 优化判断信息充分性的标准
     - 在后期迭代中适当降低充分性标准
     - 添加对查询生成质量的指导

   - REPORT_SYSTEM_PROMPT:
     - 改进报告结构和格式化指南
     - 添加对引用和来源引用的要求
     - 提供更丰富的内容组织指南

2. 对每个提示词模板实施以下优化：
   - 清晰的任务分解
   - 精确的输出要求
   - 适当的示例或模板
   - 特定于模型的调整

请提供更新后的提示词模板，并解释每项更改的目的和预期效果。
```

**测试方法：**

- 使用示例数据生成完整提示词
- 分析提示词的清晰度和结构
- 测试更新后的提示词对模型输出的影响
- 比较优化前后的输出质量

### 5. 实现模型错误处理策略

**提示词：**

```
请为 deep-research-ai-agent 项目实现全面的模型错误处理策略。AI 模型调用可能因各种原因失败，我们需要确保系统能够优雅地处理这些情况。

具体要求：
1. 更新 src/app/api/deep-research/model-caller.ts 文件：
   - 增强错误检测和分类能力
   - 实现特定于错误类型的处理策略
   - 添加智能重试逻辑（如指数退避、错误特定的重试策略）

2. 处理以下常见错误类型：
   - 速率限制或配额错误
   - 服务不可用或超时
   - 模型容量或上下文长度错误
   - 内容审核或安全筛选错误
   - 格式或解析错误

3. 实现备用策略：
   - 在一个模型失败时尝试另一个模型
   - 在结构化输出失败时回退到文本输出
   - 提供合理的默认值或部分结果

请提供更新后的错误处理代码，并解释如何处理各种错误场景。
```

**测试方法：**

- 模拟各种错误情况，测试错误处理逻辑
- 验证重试策略和退避逻辑是否正确工作
- 确认备用策略能产生合理的结果
- 测试错误报告和记录机制

### 6. 性能测试与优化

**提示词：**

```
请设计并实现一套性能测试，用于评估和优化 deep-research-ai-agent 项目中的 AI 模型集成。我们需要确保系统能够高效、可靠地利用各种 AI 模型。

具体要求：
1. 创建测试脚本，测试以下方面：
   - 模型响应时间
   - 令牌使用效率
   - 输出质量和一致性
   - 错误率和恢复能力

2. 针对以下研究任务进行基准测试：
   - 查询生成
   - 信息提取
   - 内容分析
   - 报告生成

3. 基于测试结果，提出优化建议，如：
   - 提示词调整
   - 模型选择变更
   - 参数优化
   - 输入截断或分块策略

请提供测试脚本和详细的测试计划，包括如何衡量性能和质量指标。
```

**测试方法：**

- 运行性能测试脚本，收集基准数据
- 分析不同模型和配置的性能差异
- 根据测试结果实施优化
- 验证优化后的性能改进

## 总结与下一步

完成上述步骤后，你应该已经优化了项目中的 AI 模型集成，包括模型选择、API 配置、提示词工程和错误处理。这些优化将显著提高研究质量和系统稳定性。

确保所有测试都通过后，再继续下一阶段的开发。

下一步：前往 [研究活动与报告组件](./08-研究活动与报告组件.md) 开始实现前端的活动跟踪和报告展示功能。
