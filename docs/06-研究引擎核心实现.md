# 研究引擎核心实现

本文档将指导你实现 Deep Research AI Agent 项目的核心研究引擎，这是整个系统的中枢，负责执行深度研究流程。

## 步骤概览

1. 创建研究引擎主流程
2. 实现服务集成模块
3. 创建模型调用工具
4. 设计提示词模板
5. 实现核心研究功能
6. 测试研究引擎功能

## 详细步骤与提示词

### 1. 创建研究引擎主流程

**提示词：**

```
请为 deep-research-ai-agent 项目创建研究引擎的主流程。这是整个研究过程的协调中心，负责管理研究的迭代过程。

具体要求：
1. 创建 src/app/api/deep-research/main.ts 文件
2. 实现 deepResearch 函数，该函数应接收研究状态和数据流对象
3. 实现以下流程：
   - 初始化迭代计数器和活动跟踪器
   - 生成初始搜索查询
   - 执行迭代研究循环，每轮执行：
     - 搜索相关内容
     - 处理搜索结果
     - 分析研究发现
     - 决定是否继续搜索
   - 当研究足够或达到最大迭代次数时，生成最终报告
   - 将报告通过数据流发送给前端

请确保主流程符合以下要求：
- 限制最大迭代次数（使用常量文件中的 MAX_ITERATIONS）
- 使用并行处理进行搜索和内容提取
- 累积所有研究发现以供后续分析
- 在每个步骤使用活动跟踪器记录进度

请提供完整的 main.ts 文件代码。
```

**测试方法：**

- 创建一个简单的测试脚本，使用模拟数据测试主流程
- 验证迭代逻辑和流程控制是否正确
- 确认每个步骤的活动记录是否正确

### 2. 实现服务集成模块

**提示词：**

```
请为 deep-research-ai-agent 项目实现服务集成模块。这个模块将处理外部服务的初始化和集成，如 OpenRouter 和 Exa Search。

具体要求：
1. 创建 src/app/api/deep-research/services.ts 文件
2. 实现以下功能：
   - OpenRouter 客户端初始化，使用环境变量中的 API 密钥
   - Exa Search 客户端初始化，使用环境变量中的 API 密钥
   - 导出这些服务实例以供其他模块使用
   - 添加环境变量验证或错误处理

请确保模块正确处理环境变量不存在的情况，并提供清晰的错误信息。

请提供完整的 services.ts 文件代码。
```

**测试方法：**

- 确认模块能够正确导入并初始化
- 测试环境变量缺失时的错误处理
- 验证服务实例是否正确导出

### 3. 创建模型调用工具

**提示词：**

```
请为 deep-research-ai-agent 项目创建模型调用工具。这个模块将处理与大语言模型的交互，支持结构化输出和错误重试。

具体要求：
1. 创建 src/app/api/deep-research/model-caller.ts 文件
2. 实现 callModel 函数，该函数应：
   - 支持两种模式：生成结构化对象和生成文本
   - 使用 AI SDK 的 generateObject 和 generateText 函数
   - 实现自动重试逻辑，使用常量文件中的重试参数
   - 跟踪令牌使用量并更新研究状态
   - 支持多种错误处理策略
   - 接受可选的 schema 参数以验证和解析响应

3. callModel 函数应接收以下参数：
   - model: 要使用的模型标识符
   - prompt: 提示词文本
   - system: 系统指令
   - schema: (可选) Zod 模式对象，用于验证和解析响应
   - activityType: 活动类型，用于记录和重试

请提供完整的 model-caller.ts 文件代码，确保它能与之前创建的服务模块和常量模块正确集成。
```

**测试方法：**

- 创建一个简单的测试函数，测试模型调用功能
- 验证重试逻辑是否正确工作
- 测试结构化输出和文本输出模式
- 确认错误处理和活动记录是否正确

### 4. 设计提示词模板

**提示词：**

```
请为 deep-research-ai-agent 项目设计提示词模板。这些模板将指导大语言模型完成各种研究任务，如规划、信息提取、分析和报告生成。

具体要求：
1. 创建 src/app/api/deep-research/prompts.ts 文件
2. 设计并实现以下提示词模板：

   - PLANNING_SYSTEM_PROMPT: 指导模型生成搜索查询
   - getPlanningPrompt: 接收主题和澄清信息，返回完整的规划提示

   - EXTRACTION_SYSTEM_PROMPT: 指导模型从搜索结果中提取相关信息
   - getExtractionPrompt: 接收内容、主题和澄清信息，返回提取提示

   - ANALYSIS_SYSTEM_PROMPT: 指导模型分析收集的信息，确定是否足够
   - getAnalysisPrompt: 接收多个参数，返回分析提示

   - REPORT_SYSTEM_PROMPT: 指导模型生成最终研究报告
   - getReportPrompt: 接收研究发现、主题和澄清信息，返回报告生成提示

请确保每个提示词模板都：
- 清晰指导模型完成特定任务
- 提供足够的上下文和约束
- 包含当前年份等动态信息
- 适当格式化以便于模型处理

请提供完整的 prompts.ts 文件代码。
```

**测试方法：**

- 审查提示词模板的逻辑和效果
- 创建简单的脚本，使用示例输入生成完整提示词
- 验证提示词是否包含所有必要的信息和指令

### 5. 实现核心研究功能

**提示词：**

```
请为 deep-research-ai-agent 项目实现核心研究功能。这些功能将执行研究流程中的各个步骤，如生成查询、搜索、提取和分析。

具体要求：
1. 创建 src/app/api/deep-research/research-functions.ts 文件
2. 实现以下核心函数：

   - generateSearchQueries: 生成与研究主题相关的搜索查询
     - 使用 PLANNING 模型和相应的提示词
     - 返回一组有效的搜索查询

   - search: 执行网络搜索
     - 使用 Exa API 执行每个查询
     - 过滤和格式化搜索结果
     - 限制结果数量和内容大小

   - extractContent: 从搜索结果中提取相关信息
     - 使用 EXTRACTION 模型和相应的提示词
     - 返回结构化的摘要信息

   - processSearchResults: 处理多个搜索结果
     - 并行处理多个内容提取任务
     - 汇总和过滤结果

   - analyzeFindings: 分析当前收集的信息
     - 使用 ANALYSIS 模型和相应的提示词
     - 确定是否需要更多信息，如需要则提供新查询

   - generateReport: 生成最终研究报告
     - 使用 REPORT 模型和相应的提示词
     - 生成全面且结构化的研究报告

请确保每个函数都包含适当的错误处理，并使用活动跟踪器记录进度。使用之前创建的模型调用工具、提示词模板和服务模块。

请提供完整的 research-functions.ts 文件代码。
```

**测试方法：**

- 为每个核心功能创建独立的测试函数
- 使用模拟数据测试各个函数的工作流程
- 验证错误处理和重试逻辑是否正确
- 确认活动记录是否正确更新

### 6. 集成测试整个研究流程

**提示词：**

```
请设计一个集成测试计划，用于验证整个研究引擎的功能。我们需要确保所有组件能够正确协同工作，从初始查询生成到最终报告生成。

具体要求：
1. 创建一个测试脚本，该脚本应：
   - 初始化一个测试研究状态
   - 创建一个模拟数据流
   - 调用 deepResearch 函数执行完整研究流程
   - 记录每个步骤的输出和活动
   - 验证最终报告是否生成

2. 设计测试场景，覆盖以下情况：
   - 常规研究流程，所有步骤正常执行
   - 处理部分搜索失败的情况
   - 处理空搜索结果的情况
   - 测试迭代限制是否正确工作

请提供测试脚本和详细的测试计划，包括如何验证结果和判断测试成功的标准。
```

**测试方法：**

- 运行集成测试脚本，验证完整研究流程
- 检查每个步骤的活动记录和输出
- 验证最终报告的质量和内容
- 确认错误处理和边缘情况是否正确处理

## 总结与下一步

完成上述步骤后，你应该已经实现了项目的核心研究引擎，包括主流程控制、服务集成、模型调用、提示词设计和核心研究功能。这些组件共同构成了一个强大的研究系统，能够执行多轮迭代研究并生成全面的研究报告。

确保所有测试都通过后，再继续下一阶段的开发。

下一步：前往 [AI 模型集成](./07-AI模型集成.md) 深入了解和优化与 AI 模型的交互。
